# README

## 1. 项目描述

- 通过建立佛山数据中心风冷空调预测模型，利用强化学习算法、贝叶斯优化算法实现PUE优化，并输出相关数据、算法的可视化呈现数据。
- **输入**：通过InfluxDB数据库，获取历史测点数据、实时测点数据；
- **输出**：通过Http接口，输出优化策略、可视化呈现相关数据；
- **节能增益来源**
  1. 升温：当前设定温度有冗余，尽可能提升温度但保证安全；应采用机房温度作为空调制冷启停的依据（好像和用回风温度没有区别，但是安全性更好）；
  2. 热平衡：空调制冷都会出现过热和过冷的情况，过冷是对能耗的浪费（频繁启停/制冷恰好等于热负载，能够减少过冷的情况）
  3. 多台空调负载均衡+减少启停次数：让空调处于最佳COP工作范围；启动能耗很大，减少启停次数；
  4. 随着IT负载或者环境温度的变化，即制冷需求的变化，动态调整设定温度；
- **节能方法**
  - 如果空调的启动能耗比较大，那我们应当降低空调的启停次数；引入变频后，启停变少，这一项可能不重要了；
  - 通过联合优化多台空调的温度设定值，尽可能升温，并且跟随环境、负载动态变化；
  - 目标函数设定成过去一段时间内的能耗总和，并且考虑安全边界约束：$ \min f = \sum_{t=0}^{T} P_t + \lambda(T-T_s) $ (直接和系统交互是可以的，但是要慢一点，**如何AI或者机理模型？**)
    - 引入机理模型？或者简单认为温度设定差*制冷功率=制冷量（变化是线性的），用于平衡各个空调的运行、IT负载的变化。（如果启停影响大的话，肯定得考虑）
    - AI模型：需要找到不同空调温度设定值所对应的能耗；不同IT负载、不同环境温度、不同温度设定值对应的环境温度；（如果能知道不同IT负载、不同环境温度所需的冷量会更好）

### 1.1 预测算法模块

#### 实现功能

- 随机森林、贝叶斯网络、 MLP、GRU、LSTM、Transformer
- 周期性更新和实时预测输出（已实现）
- 相关预测输出可能也要输出的

#### 实现路径

1. IT负荷预测（时序预测）
2. 机房温度预测模型（室内外温湿度、IT负载、空调参数，时序预测）
3. 能耗拟合模型（空调相关参数、室内外温湿度）

预测只要不是很离谱，和上一时刻差不多都行吧

### 1.2 优化算法模块

#### 实现功能

- 模拟退火、遗传算法、梯度下降、贝叶斯优化、深度强化学习算法（包括DQN、D3QN、BDQ、PPO、DDPG、SAC等）
- 算法中设置安全边界，下发时也要检查一次
- 周期性下发并支持回退（策略存储并标记）（和姜总对接，看是否他们实现）
- 输出指令采用http输出
- 边界温度参数可调整

#### 实现路径

1. 明确优化变量和安全边界（找他们要一个明确的清单，可以先开发）
2. 通过调整空调控制参数，可以得到机柜能耗值（拟合模型）和环境温度（预测模型），保证环境温度不超过边界，找一个机柜能耗最小值的点就可以了。

### 1.3 可视化呈现模块

具体呈现形式需要和姜总对接

- 最终PUE优化的结果、不同时点、时段等PUE实时数据或曲线等形式（与原算法的对比？）；预测算法预测准确率的训练曲线、优化算法优化PUE值的迭代曲线、算法的训练时间、算法运行时间等。

## 2. Requirements

- Python
- InfluxDB
- MQTT

## 3. 代码结构 (待修改)

- main.py：拟合并更新神经网络、实时预测功耗
- get_data：从数据库中读取历史数据以及实时更新数据
- data_process：数据预处理
- device.py：设备参数
- model.py：神经网络训练、预测代码

## 4. 使用指南 (待修改)

- pip install -r requirement.txt (推荐python版本:3.8以上)
- 编写configs.yaml配置文件
  - influxdb：数据库连接配置
  - num_list：设备个数列表，列表元素顺序为[压缩机个数，氟泵个数，冷凝风机个数，室内空调风机个数，喷淋水泵个数]
  - RP_u：机组额定功率
  - input_uid：各设备uid，输入顺序与num_list相同（若有多个同种设备，例如，num_list=[1,2,1,1,1],先将压缩机uid填写完成，再将两个氟泵uid填写完成，再填写冷凝风机uid，类别顺序不可变）
    -压缩机（compressor）参数：{P_dis:压缩机排气压力,P_suc:压缩机吸气压力,Fs4:压缩机输出}
    -氟泵（fu pump）参数：{P_outlet:氟泵出口压力,P_inlet:氟泵进口压力,SP_fp:氟泵输出%}
    -冷凝风机（ofn）参数：{Fs2:冷凝风机输出}
    -室内风机（lfn）参数：{Fs1:空调风机实时转速}
    -喷淋泵（spray pump）参数：{Fs3:喷淋泵输出}
    -总功率（Power_all）参数：{P_all:整机功率}
  - output_uid：各设备功率输出uid，有神经网络拟合输出（net）以及计算公式输出（format）
  - mqtt：
    - transport：传输方式
    - broker_address：mqtt协议传输地址
    - port：mqtt协议端口
    - node：节点编号
- 运行main1可执行文件

## 5. 部署指南

部署环境往往是离线的，因此直接安装python包进行编译可能比较困难。提前下载python依赖包在部署环境进行编译也可以，不过部署环境可能与本地环境也不同，也比较麻烦。目前推荐编译完成后，将编译后的文件拷贝到部署环境中。

1. 使用conda等方法创建与部署环境版本一致的python环境，并安装依赖包
   1. 默认安装gpu版本torch，安装cpu版本使用命令`pip3 install torch --index-url https://download.pytorch.org/whl/cpu`（命令可以在[pytorch官网](https://pytorch.org/get-started/locally/)找到）
2. 测试并Debug，解决版本兼容性导致的bug
3. 编译：`pyinstaller -F main.py`
4. 将编译后的文件拷贝到部署环境中，安装一些缺少的依赖，比如`glibc_2.35`等

## 6. 自启动服务设置

为保障程序能够开机自启动、自动重启、后台运行，可以使用`systemd`服务管理器保障程序的运行。

1. 创建一个`systemd`服务单元文件

    ```bash
    sudo nano /etc/systemd/system/AI.service
    ```

2. 编辑服务单元文件

    ```bash
    [Unit]
    Description=AI Service
    After=network.target

    [Service]
    ExecStart=/root/AI_power_predict/main1
    WorkingDirectory=/root/AI_power_predict/
    Restart=always
    RestartSec=5
    User=root

    [Install]
    WantedBy=multi-user.target
    ```

3. 重新加载`systemd`配置

    ```bash
    sudo systemctl daemon-reload
    ```

4. 启动并启用服务

    ```bash
    sudo systemctl start AI.service
    ```

    启用服务使其在系统启动时自动启动：

    ```bash
    sudo systemctl enable AI.service
    ```

5. 检查服务状态

    ```bash
    sudo systemctl status AI.service
    ```

## 7. TODO (待修改)

1. 修改完善代码
2. 考虑对多台空调的支持
   - 多台空调共用一个模型参数（现有方法，需要完善输入config形式，RP_u也应支持多台空调）
   - 每台空调单独一个模型参数（考虑模型的迁移性/通用性）
3. 加密编译
